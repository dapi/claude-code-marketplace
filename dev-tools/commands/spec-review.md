---
description: Ревью спецификации или ТЗ на гапы, нестыковки, противоречия и оценку объёма
argument-hint: [Google Doc URL | GitHub Issue URL | file path]
version: "1.1.0"
---

# Spec Review Command

Комплексное ревью спецификации с параллельным техническим, бизнес и scope-анализом.
**Итеративный процесс** до устранения всех критичных и высоких замечаний.

```
┌───────────────────────────────────────────────────────────────────────────┐
│                              /spec-review                                  │
│                               (команда)                                    │
└─────────────────────────────────┬─────────────────────────────────────────┘
                                  │
        ┌─────────────┬───────────┼───────────┬─────────────┐
        │             │           │           │             │
        ▼             ▼           ▼           ▼             ▼
┌─────────────┐┌─────────────┐┌─────────────┐┌─────────────┐┌─────────────┐
│  spec-data  ││  spec-api   ││ spec-infra  ││spec-analyst ││ spec-scoper │
│  (данные)   ││   (API)     ││  (infra)    ││  (бизнес)   ││  (объём)    │
└──────┬──────┘└──────┬──────┘└──────┬──────┘└──────┬──────┘└──────┬──────┘
       │              │              │              │              │
       │              │       ПАРАЛЛЕЛЬНО (5)       │              │
       └──────────────┴──────────────┼──────────────┴──────────────┘
                                     │
                                     ▼
                          ┌─────────────────┐
                          │   Объединение   │
                          │   результатов   │
                          └────────┬────────┘
                      │
          ┌───────────┴───────────┐
          │                       │
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │  Проблемы   │        │   Scope     │
   │  качества   │        │  (разбиение)│
   └──────┬──────┘        └──────┬──────┘
          │                      │
          └──────────┬───────────┘
                     │
                     ▼
          ┌─────────────────┐
          │    Процесс      │◄─────────────────┐
          │    аппрува      │                  │
          └────────┬────────┘                  │
                   │                           │
                   ▼                           │
          ┌─────────────────┐                  │
          │   GATE CHECK    │                  │
          │ critical/high?  │                  │
          └────────┬────────┘                  │
                   │                           │
         ┌─────────┴─────────┐                 │
         │                   │                 │
         ▼                   ▼                 │
   ┌───────────┐      ┌───────────┐            │
   │  ✅ НЕТ   │      │  ⚠️ ДА    │            │
   │  (чисто)  │      │ (есть)    │            │
   └─────┬─────┘      └─────┬─────┘            │
         │                  │                  │
         ▼                  ▼                  │
   ┌───────────┐      ┌───────────┐            │
   │  Фаза 7   │      │ iteration │            │
   │  ФИНАЛ    │      │   < 3?    │            │
   └───────────┘      └─────┬─────┘            │
                            │                  │
                  ┌─────────┴─────────┐        │
                  │                   │        │
                  ▼                   ▼        │
           ┌───────────┐       ┌───────────┐   │
           │    ДА     │       │    НЕТ    │   │
           │ (повтор)  │       │ (лимит)   │   │
           └─────┬─────┘       └─────┬─────┘   │
                 │                   │         │
                 │                   ▼         │
                 │            ┌───────────┐    │
                 │            │ Спросить  │    │
                 │            │ юзера     │    │
                 │            └─────┬─────┘    │
                 │                  │          │
                 └──────► Фаза 2 ◄──┘──────────┘
                        (re-analyze)
```

## Критерии качества

| Критерий | Символ | Что проверяем |
|----------|--------|---------------|
| **Гапы** | 🕳️ | Отсутствующая информация |
| **Нестыковки** | ⚡ | Противоречия между разделами |
| **Неоднозначность** | 🔮 | Двойные толкования |
| **Непроверяемость** | 🎯 | Субъективные критерии |
| **Нереализуемость** | 🚫 | Технически невозможно |
| **Нетестируемость** | 🧪 | Невозможно написать тесты |

---

## Переменные состояния

```
VERSION = "1.1.0"                # Версия команды (синхронизирована с frontmatter)
iteration = 1                    # Текущая итерация (начинаем с 1)
max_iterations = 3               # Максимум итераций
spec_content = ""                # Текст спецификации
issues_history = []              # История проблем по итерациям
```

---

## Фаза 1: Получение спецификации

### Источники

| Источник | Как получить |
|----------|--------------|
| **Google Doc** | MCP: `mcp__google_workspace__get_doc_content` |
| **Google Spreadsheet** | MCP: `mcp__google_workspace__read_sheet_values` |
| **GitHub Issue** | CLI: `gh issue view <number> --json body,title` |
| **Локальный файл** | Tool: `Read` |

**Аргумент команды:** `$ARGUMENTS`
- Если пусто — спроси: "Укажи ссылку на Google Doc, номер GitHub issue или путь к файлу"

**Извлечение ID:**
- Google Doc: `https://docs.google.com/document/d/{DOCUMENT_ID}/edit` → `{DOCUMENT_ID}`
- GitHub Issue: `https://github.com/{owner}/{repo}/issues/{number}` → `gh issue view {number}`

---

## Фаза 2: Параллельный анализ

### КРИТИЧЕСКИ ВАЖНО: Запуск субагентов

**Используй Task tool для запуска ВСЕХ ПЯТИ агентов ОДНОВРЕМЕННО в ОДНОМ сообщении:**

```
Task 1:
  subagent_type: "dev-tools:spec-data"
  description: "Анализ данных спецификации"
  prompt: |
    Проанализируй спецификацию с точки зрения данных:
    модели, схемы БД, миграции, связи, валидация.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 2:
  subagent_type: "dev-tools:spec-api"
  description: "Анализ API спецификации"
  prompt: |
    Проанализируй спецификацию с точки зрения API:
    endpoints, контракты, интеграции, webhooks, error handling.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 3:
  subagent_type: "dev-tools:spec-infra"
  description: "Анализ инфраструктуры спецификации"
  prompt: |
    Проанализируй спецификацию с точки зрения инфраструктуры:
    безопасность, производительность, deployment, мониторинг.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 4:
  subagent_type: "dev-tools:spec-analyst"
  description: "Бизнес-анализ спецификации"
  prompt: |
    Проанализируй спецификацию с бизнес точки зрения:
    user stories, acceptance criteria, роли, права доступа.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 5:
  subagent_type: "dev-tools:spec-scoper"
  description: "Оценка объёма спецификации"
  prompt: |
    Оцени объём работы по спецификации.
    Определи, влезает ли в одну сессию.
    Если нет — предложи разбиение на части.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===
```

**Все пять Task вызовов должны быть в ОДНОМ сообщении для параллельного выполнения!**

---

## Фаза 3: Объединение результатов

После получения JSON от всех пяти субагентов:

### 3.1 Парсинг результатов

```
data_result = JSON.parse(data_output)       # D-XXX issues
api_result = JSON.parse(api_output)         # P-XXX issues
infra_result = JSON.parse(infra_output)     # N-XXX issues
analyst_result = JSON.parse(analyst_output) # B-XXX issues (business)
scoper_result = JSON.parse(scoper_output)   # scope analysis
```

### 3.2 Объединение issues (качество)

```
all_issues = data_result.issues + api_result.issues + infra_result.issues + analyst_result.issues
```

### 3.3 Сортировка по severity

```
Порядок: critical → high → medium → low
```

### 3.4 Формирование сводки качества

```
quality_summary = {
  critical: count(severity == "critical"),
  high: count(severity == "high"),
  medium: count(severity == "medium"),
  low: count(severity == "low")
}
```

### 3.5 Анализ scope

```
scope_verdict = scoper_result.verdict  // "fits" | "borderline" | "too_large"
breakdown = scoper_result.breakdown
suggested_plan = scoper_result.suggested_plan
```

---

## Фаза 4: Обработка Scope (если too_large/borderline)

### Если `verdict: "too_large"` или `verdict: "borderline"`

Показать пользователю breakdown и запросить решение:

```markdown
## 📐 Оценка объёма спецификации

**Verdict:** ⚠️ Слишком большая / ⚡ На грани
**Estimated complexity:** XL
**Элементы:** N моделей, M endpoints, K компонентов

### Предлагаемое разбиение

| # | Часть | Сложность | Зависит от | Рекомендация |
|---|-------|-----------|------------|--------------|
| 1 | {title} | M | - | ✅ Фаза 1 |
| 2 | {title} | L | #1 | ✅ Фаза 2 |
| 3 | {title} | XL | #1, #2 | 📋 Sub-issue |

### Граф зависимостей

PART-001 ──► PART-002 ──► PART-003
                └──────────► PART-004
```

### AskUserQuestion: Что делать со scope?

1. **✅ Принять разбиение**
   → Создать sub-issues для out_of_scope частей
   → Обновить спецификацию с планом фаз

2. **🔄 Скорректировать вручную**
   → Запросить какие части перенести/оставить

3. **⏭️ Игнорировать (риск!)**
   → Продолжить без разбиения
   → Добавить warning в отчёт

### Создание Sub-issues для out_of_scope частей

Для каждой части с `recommendation: "out_of_scope_subissue"`:

```bash
gh issue create \
  --repo {owner}/{repo} \
  --title "[Part {id}] {title}" \
  --body "$(cat <<'EOF'
## Контекст
Выделено из спецификации: {ссылка на основную спеку}
Parent issue: #{parent_issue_number}

## Scope
{список элементов из scope}

## Сложность: {complexity}

## Зависимости
{depends_on или "Нет"}

## Описание
{description}

---
_Spec Review | {дата}_
EOF
)"
```

### Обновление основной спецификации

Если пользователь принял разбиение, добавить в документ:

```markdown
## План реализации

### Фаза 1 (текущая задача)
- [ ] {PART-001 title}
- [ ] {PART-002 title}

### Вынесено в отдельные задачи
- [ ] {PART-003 title} → #{issue_number}
- [ ] {PART-004 title} → #{issue_number}
```

---

## Фаза 5: Презентация результатов

### Формат отчёта

```markdown
## 📋 Результаты ревью спецификации

**Документ:** [название/ссылка]
**Дата ревью:** [дата]
**Итерация:** {iteration} из {max_iterations}
**Статус:** ⏳ Требует доработки / ✅ Готова к аппруву

---

### 📐 Оценка объёма

| Verdict | Complexity | Модели | Endpoints | Компоненты |
|---------|------------|--------|-----------|------------|
| ✅ Влезает / ⚠️ На грани / ❌ Слишком большая | S/M/L/XL | N | N | N |

**План реализации:** [Фаза 1: X, Фаза 2: Y] | [Sub-issues: #N, #M]

---

### 🔍 Качество спецификации

| Источник | 🔴 Крит. | 🟠 Выс. | 🟡 Сред. | 🟢 Низ. |
|----------|----------|---------|----------|---------|
| 🗄️ Data (D-XXX) | N | N | N | N |
| 🔌 API (P-XXX) | N | N | N | N |
| 🛡️ Infra (N-XXX) | N | N | N | N |
| 📊 Analyst (B-XXX) | N | N | N | N |
| **Итого** | **N** | **N** | **N** | **N** |

### 🔴 Критичные проблемы
[список]

### 🟠 Высокие проблемы
[список]

### 🟡 Средние проблемы
[список]

### 🟢 Рекомендации
[список]
```

### Если iteration > 1: Показать прогресс

```markdown
---

### 📈 Прогресс между итерациями

| Итерация | 🔴 Крит. | 🟠 Выс. | 🟡 Сред. | 🟢 Низ. | Δ |
|----------|----------|---------|----------|---------|---|
| #1 | 3 | 5 | 4 | 2 | - |
| #2 | 1 | 2 | 4 | 2 | ✅ -5 |
| #3 (текущая) | 0 | 0 | 3 | 2 | ✅ -3 |

**Устранено за все итерации:** 8 критичных/высоких проблем
```

---

## Фаза 6: Процесс аппрува

### Для каждого замечания (начиная с критичных)

Используй **AskUserQuestion** с вариантами:

1. **✅ Принять и учесть в ТЗ**
   → Сформулировать изменения → внести в документ

2. **📋 Вынести в отдельную задачу**
   → Создать GitHub issue через `gh issue create`

3. **⏭️ Отклонить**
   → Запросить причину → добавить комментарий в спецификацию

### Создание GitHub issue для отложенного замечания

```bash
gh issue create \
  --repo {owner}/{repo} \
  --title "[Spec Review] {title}" \
  --body "$(cat <<'EOF'
## Контекст
Выявлено в ходе ревью: {ссылка на спеку}

## Тип: {type_emoji} {type}
## Severity: {severity_emoji} {severity}

## Описание
{description}

## Рекомендация
{recommendation}

---
_Spec Review | {дата}_
EOF
)"
```

---

## Фаза 6.5: Gate Check (ИТЕРАТИВНЫЙ ЦИКЛ)

После обработки всех замечаний в Фазе 6, выполни проверку:

### Условия для повторной итерации

```python
# Подсчитай оставшиеся critical/high
remaining_critical = count(issues where severity == "critical" AND status != "fixed")
remaining_high = count(issues where severity == "high" AND status != "fixed")

has_blocking_issues = (remaining_critical > 0) OR (remaining_high > 0)
can_iterate = iteration < max_iterations
```

### Логика принятия решения

```
IF NOT has_blocking_issues:
    → Перейти к Фазе 7 (Финализация)

ELIF has_blocking_issues AND can_iterate:
    → Показать прогресс
    → Автоматически перейти к Фазе 2 (повторный анализ)
    → iteration += 1

ELIF has_blocking_issues AND NOT can_iterate:
    → Показать предупреждение о лимите итераций
    → Спросить пользователя: продолжить или принять как есть?
```

### Если достигнут лимит итераций

Используй **AskUserQuestion**:

```markdown
## ⚠️ Достигнут лимит итераций ({max_iterations})

Осталось нерешённых проблем:
- 🔴 Критичных: {remaining_critical}
- 🟠 Высоких: {remaining_high}

**Прогресс за {iteration} итераций:**
[показать таблицу прогресса]
```

**Варианты:**

1. **🔄 Продолжить ещё одну итерацию**
   → max_iterations += 1
   → Перейти к Фазе 2

2. **✅ Принять спецификацию как есть**
   → Добавить warning о нерешённых проблемах
   → Перейти к Фазе 7

3. **❌ Отменить ревью**
   → Завершить без аппрува

### Сообщение при переходе к новой итерации

```markdown
---

## 🔄 Итерация {iteration} → {iteration + 1}

**Причина:** Остались критичные/высокие замечания

| Тип | Осталось | Исправлено в этой итерации |
|-----|----------|---------------------------|
| 🔴 Критичные | {N} | {M} |
| 🟠 Высокие | {N} | {M} |

**Перечитываю спецификацию и запускаю повторный анализ...**

---
```

Затем:
1. Перечитай спецификацию (она могла измениться)
2. Вернись к Фазе 2 (параллельный анализ)

---

## Фаза 7: Финализация

### Если нет критичных и высоких

```markdown
## ✅ Спецификация готова к аппруву

**Итераций потребовалось:** {iteration}
**Критичных и высоких замечаний:** 0

### Статистика ревью:
| Метрика | Значение |
|---------|----------|
| Всего выявлено проблем | N |
| Исправлено | M |
| Отложено (GitHub issues) | K |
| Отклонено | L |

### Несущественные рекомендации:
- [список оставшихся medium/low]

Принять спецификацию?
```

### При принятии

1. Добавь `[APPROVED]` в заголовок
2. Добавь метку аппрува:
   ```
   > **[Approved by @{github_username} {YYYY-MM-DD HH:MM}]**
   > Спецификация прошла архитектурное и бизнес-ревью.
   > Итераций: {iteration}. Исправлено проблем: {total_fixed}.
   ```

3. Получи username: `gh api user --jq '.login'`

4. В конце отчёта добавь футер с версией:
   ```
   ---
   _Spec Review v{VERSION} | {YYYY-MM-DD}_
   ```

---

## ID префиксы по агентам

| Агент | Prefix | Описание |
|-------|--------|----------|
| spec-data | D-XXX | Проблемы с данными |
| spec-api | P-XXX | Проблемы с API/интеграциями |
| spec-infra | N-XXX | Проблемы с инфраструктурой/NFR |
| spec-analyst | B-XXX | Бизнес-проблемы |

## Символы для типов проблем

| Тип | Символ |
|-----|--------|
| gap | 🕳️ |
| inconsistency | ⚡ |
| ambiguity | 🔮 |
| unverifiability | 🎯 |
| infeasibility | 🚫 |
| untestability | 🧪 |

## Символы для severity

| Severity | Символ |
|----------|--------|
| critical | 🔴 |
| high | 🟠 |
| medium | 🟡 |
| low | 🟢 |

---

## Интеграции

### GitHub Issues (gh CLI)

**Чтение:**
```bash
gh issue view <number> --repo owner/repo --json title,body
```

**Создание:**
```bash
gh issue create --repo owner/repo --title "..." --body "..."
```

**Комментарий:**
```bash
gh issue comment <number> --repo owner/repo --body "..."
```

### Google Docs (MCP)

**Чтение:**
```
mcp__google_workspace__get_doc_content
  documentId: "{DOCUMENT_ID}"
```

**Редактирование:**
```
mcp__google_workspace__modify_doc_text
  documentId: "{DOCUMENT_ID}"
  operations: [{"action": "insert", "text": "[APPROVED] ", "index": 1}]
```

---

## Чеклист

### Инициализация
- [ ] Спецификация получена
- [ ] `iteration = 1` установлен
- [ ] `issues_history = []` инициализирован

### Цикл анализа (повторяется до iteration <= max_iterations)
- [ ] Запущены ВСЕ ПЯТЬ субагентов ПАРАЛЛЕЛЬНО (в одном сообщении)
- [ ] Результаты получены и распарсены
- [ ] **Scope обработан (только на iteration == 1):**
  - [ ] Если too_large/borderline — показан breakdown
  - [ ] Пользователь выбрал стратегию
  - [ ] Sub-issues созданы для out_of_scope частей
  - [ ] План фаз добавлен в спецификацию
- [ ] Отчёт сформирован с номером итерации
- [ ] Показан прогресс (если iteration > 1)
- [ ] Критичные и высокие замечания обработаны
- [ ] GitHub issues созданы для отложенных задач
- [ ] Причины отклонений задокументированы

### Gate Check (после каждой итерации)
- [ ] Подсчитаны оставшиеся critical/high
- [ ] Если есть — проверен лимит итераций
- [ ] Если лимит — спрошен пользователь
- [ ] Решение принято (повтор / принять / отмена)
- [ ] `issues_history.push(current_issues)` для отслеживания прогресса

### Финализация
- [ ] Все critical/high устранены ИЛИ пользователь принял как есть
- [ ] Статистика ревью показана
- [ ] Спецификация помечена [APPROVED] (если применимо)
- [ ] Указано количество итераций и исправленных проблем
