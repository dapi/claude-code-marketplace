---
description: Ревью спецификации или ТЗ на гапы, нестыковки, противоречия и оценку объёма
argument-hint: [Google Doc URL | GitHub Issue URL | file path]
---

# Spec Review Command

Комплексное ревью спецификации с параллельным техническим, бизнес и scope-анализом.

```
┌─────────────────────────────────────────────────────────┐
│                   /spec-review                          │
│                   (команда)                             │
└────────────────────────┬────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   spec-     │  │   spec-     │  │   spec-     │
│  architect  │  │   analyst   │  │   scoper    │
│ (техн.)     │  │ (бизнес)    │  │ (объём)     │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       │         ПАРАЛЛЕЛЬНО             │
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
             ┌─────────────────┐
             │   Объединение   │
             │   результатов   │
             └────────┬────────┘
                      │
          ┌───────────┴───────────┐
          │                       │
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │  Проблемы   │        │   Scope     │
   │  качества   │        │  (разбиение)│
   └──────┬──────┘        └──────┬──────┘
          │                      │
          └──────────┬───────────┘
                     │
                     ▼
          ┌─────────────────┐
          │    Процесс      │
          │    аппрува      │
          └─────────────────┘
```

## Критерии качества

| Критерий | Символ | Что проверяем |
|----------|--------|---------------|
| **Гапы** | 🕳️ | Отсутствующая информация |
| **Нестыковки** | ⚡ | Противоречия между разделами |
| **Неоднозначность** | 🔮 | Двойные толкования |
| **Непроверяемость** | 🎯 | Субъективные критерии |
| **Нереализуемость** | 🚫 | Технически невозможно |
| **Нетестируемость** | 🧪 | Невозможно написать тесты |

---

## Фаза 1: Получение спецификации

### Источники

| Источник | Как получить |
|----------|--------------|
| **Google Doc** | MCP: `mcp__google_workspace__get_doc_content` |
| **Google Spreadsheet** | MCP: `mcp__google_workspace__read_sheet_values` |
| **GitHub Issue** | CLI: `gh issue view <number> --json body,title` |
| **Локальный файл** | Tool: `Read` |

**Аргумент команды:** `$ARGUMENTS`
- Если пусто — спроси: "Укажи ссылку на Google Doc, номер GitHub issue или путь к файлу"

**Извлечение ID:**
- Google Doc: `https://docs.google.com/document/d/{DOCUMENT_ID}/edit` → `{DOCUMENT_ID}`
- GitHub Issue: `https://github.com/{owner}/{repo}/issues/{number}` → `gh issue view {number}`

---

## Фаза 2: Параллельный анализ

### КРИТИЧЕСКИ ВАЖНО: Запуск субагентов

**Используй Task tool для запуска ВСЕХ ТРЁХ агентов ОДНОВРЕМЕННО в ОДНОМ сообщении:**

```
Task 1:
  subagent_type: "dev-tools:spec-architect"
  description: "Архитектурный анализ спецификации"
  prompt: |
    Проанализируй следующую спецификацию с технической точки зрения.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 2:
  subagent_type: "dev-tools:spec-analyst"
  description: "Бизнес-анализ спецификации"
  prompt: |
    Проанализируй следующую спецификацию с бизнес точки зрения.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===

Task 3:
  subagent_type: "dev-tools:spec-scoper"
  description: "Оценка объёма спецификации"
  prompt: |
    Оцени объём работы по спецификации.
    Определи, влезает ли в одну сессию.
    Если нет — предложи разбиение на части.
    Верни результат в формате JSON.

    === СПЕЦИФИКАЦИЯ ===
    {полный текст спецификации}
    === КОНЕЦ СПЕЦИФИКАЦИИ ===
```

**Все три Task вызова должны быть в ОДНОМ сообщении для параллельного выполнения!**

---

## Фаза 3: Объединение результатов

После получения JSON от всех трёх субагентов:

### 3.1 Парсинг результатов

```
architect_result = JSON.parse(architect_output)
analyst_result = JSON.parse(analyst_output)
scoper_result = JSON.parse(scoper_output)
```

### 3.2 Объединение issues (качество)

```
all_issues = architect_result.issues + analyst_result.issues
```

### 3.3 Сортировка по severity

```
Порядок: critical → high → medium → low
```

### 3.4 Формирование сводки качества

```
quality_summary = {
  critical: count(severity == "critical"),
  high: count(severity == "high"),
  medium: count(severity == "medium"),
  low: count(severity == "low")
}
```

### 3.5 Анализ scope

```
scope_verdict = scoper_result.verdict  // "fits" | "borderline" | "too_large"
breakdown = scoper_result.breakdown
suggested_plan = scoper_result.suggested_plan
```

---

## Фаза 4: Обработка Scope (если too_large/borderline)

### Если `verdict: "too_large"` или `verdict: "borderline"`

Показать пользователю breakdown и запросить решение:

```markdown
## 📐 Оценка объёма спецификации

**Verdict:** ⚠️ Слишком большая / ⚡ На грани
**Estimated complexity:** XL
**Элементы:** N моделей, M endpoints, K компонентов

### Предлагаемое разбиение

| # | Часть | Сложность | Зависит от | Рекомендация |
|---|-------|-----------|------------|--------------|
| 1 | {title} | M | - | ✅ Фаза 1 |
| 2 | {title} | L | #1 | ✅ Фаза 2 |
| 3 | {title} | XL | #1, #2 | 📋 Sub-issue |

### Граф зависимостей

PART-001 ──► PART-002 ──► PART-003
                └──────────► PART-004
```

### AskUserQuestion: Что делать со scope?

1. **✅ Принять разбиение**
   → Создать sub-issues для out_of_scope частей
   → Обновить спецификацию с планом фаз

2. **🔄 Скорректировать вручную**
   → Запросить какие части перенести/оставить

3. **⏭️ Игнорировать (риск!)**
   → Продолжить без разбиения
   → Добавить warning в отчёт

### Создание Sub-issues для out_of_scope частей

Для каждой части с `recommendation: "out_of_scope_subissue"`:

```bash
gh issue create \
  --repo {owner}/{repo} \
  --title "[Part {id}] {title}" \
  --body "$(cat <<'EOF'
## Контекст
Выделено из спецификации: {ссылка на основную спеку}
Parent issue: #{parent_issue_number}

## Scope
{список элементов из scope}

## Сложность: {complexity}

## Зависимости
{depends_on или "Нет"}

## Описание
{description}

---
_Spec Review | {дата}_
EOF
)"
```

### Обновление основной спецификации

Если пользователь принял разбиение, добавить в документ:

```markdown
## План реализации

### Фаза 1 (текущая задача)
- [ ] {PART-001 title}
- [ ] {PART-002 title}

### Вынесено в отдельные задачи
- [ ] {PART-003 title} → #{issue_number}
- [ ] {PART-004 title} → #{issue_number}
```

---

## Фаза 5: Презентация результатов

### Формат отчёта

```markdown
## 📋 Результаты ревью спецификации

**Документ:** [название/ссылка]
**Дата ревью:** [дата]
**Статус:** ⏳ Требует доработки / ✅ Готова к аппруву

---

### 📐 Оценка объёма

| Verdict | Complexity | Модели | Endpoints | Компоненты |
|---------|------------|--------|-----------|------------|
| ✅ Влезает / ⚠️ На грани / ❌ Слишком большая | S/M/L/XL | N | N | N |

**План реализации:** [Фаза 1: X, Фаза 2: Y] | [Sub-issues: #N, #M]

---

### 🔍 Качество спецификации

| Источник | 🔴 Крит. | 🟠 Выс. | 🟡 Сред. | 🟢 Низ. |
|----------|----------|---------|----------|---------|
| 🏗️ Архитектор | N | N | N | N |
| 📊 Аналитик | N | N | N | N |
| **Итого** | **N** | **N** | **N** | **N** |

### 🔴 Критичные проблемы
[список]

### 🟠 Высокие проблемы
[список]

### 🟡 Средние проблемы
[список]

### 🟢 Рекомендации
[список]
```

---

## Фаза 6: Процесс аппрува

### Для каждого замечания (начиная с критичных)

Используй **AskUserQuestion** с вариантами:

1. **✅ Принять и учесть в ТЗ**
   → Сформулировать изменения → внести в документ

2. **📋 Вынести в отдельную задачу**
   → Создать GitHub issue через `gh issue create`

3. **⏭️ Отклонить**
   → Запросить причину → добавить комментарий в спецификацию

### Создание GitHub issue для отложенного замечания

```bash
gh issue create \
  --repo {owner}/{repo} \
  --title "[Spec Review] {title}" \
  --body "$(cat <<'EOF'
## Контекст
Выявлено в ходе ревью: {ссылка на спеку}

## Тип: {type_emoji} {type}
## Severity: {severity_emoji} {severity}

## Описание
{description}

## Рекомендация
{recommendation}

---
_Spec Review | {дата}_
EOF
)"
```

---

## Фаза 7: Финализация

### Если нет критичных и высоких

```markdown
## ✅ Спецификация готова к аппруву

Критичных и высоких замечаний не выявлено.

### Несущественные рекомендации:
- [список]

Принять спецификацию?
```

### При принятии

1. Добавь `[APPROVED]` в заголовок
2. Добавь метку аппрува:
   ```
   > **[Approved by @{github_username} {YYYY-MM-DD HH:MM}]**
   > Спецификация прошла архитектурное и бизнес-ревью.
   ```

3. Получи username: `gh api user --jq '.login'`

---

## Символы для типов проблем

| Тип | Символ | ID prefix |
|-----|--------|-----------|
| gap | 🕳️ | G-XXX |
| inconsistency | ⚡ | I-XXX |
| ambiguity | 🔮 | A-XXX |
| unverifiability | 🎯 | V-XXX |
| infeasibility | 🚫 | F-XXX |
| untestability | 🧪 | T-XXX |

## Символы для severity

| Severity | Символ |
|----------|--------|
| critical | 🔴 |
| high | 🟠 |
| medium | 🟡 |
| low | 🟢 |

---

## Интеграции

### GitHub Issues (gh CLI)

**Чтение:**
```bash
gh issue view <number> --repo owner/repo --json title,body
```

**Создание:**
```bash
gh issue create --repo owner/repo --title "..." --body "..."
```

**Комментарий:**
```bash
gh issue comment <number> --repo owner/repo --body "..."
```

### Google Docs (MCP)

**Чтение:**
```
mcp__google_workspace__get_doc_content
  documentId: "{DOCUMENT_ID}"
```

**Редактирование:**
```
mcp__google_workspace__modify_doc_text
  documentId: "{DOCUMENT_ID}"
  operations: [{"action": "insert", "text": "[APPROVED] ", "index": 1}]
```

---

## Чеклист

- [ ] Спецификация получена
- [ ] Запущены ВСЕ ТРИ субагента ПАРАЛЛЕЛЬНО (в одном сообщении)
- [ ] Результаты получены и распарсены
- [ ] **Scope обработан:**
  - [ ] Если too_large/borderline — показан breakdown
  - [ ] Пользователь выбрал стратегию (принять/скорректировать/игнорировать)
  - [ ] Sub-issues созданы для out_of_scope частей
  - [ ] План фаз добавлен в спецификацию
- [ ] Отчёт сформирован и показан пользователю
- [ ] Критичные и высокие замечания обработаны
- [ ] GitHub issues созданы для отложенных задач
- [ ] Причины отклонений задокументированы
- [ ] Спецификация помечена [APPROVED] (если применимо)
