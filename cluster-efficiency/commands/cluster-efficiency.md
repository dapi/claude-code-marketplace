# /cluster-efficiency â€” ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°

Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° Kubernetes.

## ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹

ÐŸÐµÑ€ÐµÐ´Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· `$ARGUMENTS`:
- `--context=NAME` â€” Kubernetes ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
- `--namespace=NS` â€” Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ namespace
- `--focus=AREA` â€” Ð¤Ð¾ÐºÑƒÑ: all, nodes, workloads, karpenter, cost
- `--save` â€” Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚
- `--compare` â€” Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼
- `--prometheus` â€” Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Prometheus
- `--deep` â€” Ð“Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ñ Ð¿Ð¾Ð´Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸

## Ð ÐµÐ¶Ð¸Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

### Ð¤Ð°Ð·Ð° 0: Ð¡Ð±Ð¾Ñ€ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° (ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž!)

**ÐŸÐ•Ð Ð•Ð” Ð»ÑŽÐ±Ñ‹Ð¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð¼:**

1. **ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð¹ Ð¶ÑƒÑ€Ð½Ð°Ð» Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²**:
```bash
cat docs/resource-changes.md 2>/dev/null || echo "âš ï¸ Ð–ÑƒÑ€Ð½Ð°Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
```

2. **ÐŸÐ¾Ð»ÑƒÑ‡Ð¸ OOM Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ**:
```bash
kubectl get events -A --field-selector reason=OOMKilling --sort-by='.lastTimestamp' | tail -20
```

3. **Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ "Ð·Ð°Ñ‰Ð¸Ñ‚Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº"** workloads, Ð´Ð»Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž.

### Ð¤Ð°Ð·Ð° 1: Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·

1. **ÐÐ°Ð¹Ð´Ð¸ skill Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ**:
```bash
SKILL_DIR=$(find ~/.claude -path "*/cluster-efficiency/cluster-efficiency.sh" -type f 2>/dev/null | head -1 | xargs dirname)
```

2. **Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·**:
```bash
cd "$SKILL_DIR" && ./cluster-efficiency.sh $ARGUMENTS
```

### Ð¤Ð°Ð·Ð° 2: Ð“Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·

3. **Ð•ÑÐ»Ð¸ `--deep` Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÑÐµÑ€ÑŒÑ‘Ð·Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹** â€” Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð¿Ð¾Ð´Ð°Ð³ÐµÐ½Ñ‚Ñ‹ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾:
```
Task(subagent_type="cluster-efficiency:node-analyzer", prompt="...")
Task(subagent_type="cluster-efficiency:workload-analyzer", prompt="...")
Task(subagent_type="cluster-efficiency:karpenter-analyzer", prompt="...")
```

4. **Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚**

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

```bash
# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
/cluster-efficiency

# ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°
/cluster-efficiency --context=production --save

# Ð“Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ñ Ð¿Ð¾Ð´Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸
/cluster-efficiency --deep

# ÐÐ½Ð°Ð»Ð¸Ð· workloads Ð² namespace
/cluster-efficiency --namespace=production --focus=workloads

# Ð¡ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
/cluster-efficiency --prometheus --period=7d
```

## Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð°

```
=== CLUSTER EFFICIENCY SUMMARY ===

ðŸ“Š Ð£Ñ‚Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ:
- Ð¡Ñ€ÐµÐ´Ð½ÑÑ CPU: X% (target: 70%)
- Ð¡Ñ€ÐµÐ´Ð½ÑÑ Memory: Y%
- ÐÐ¾Ð´Ñ‹ Ñ Ð½Ð¸Ð·ÐºÐ¾Ð¹ ÑƒÑ‚Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹: N

âš ï¸ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:
- [HIGH] ...
- [MEDIUM] ...

ðŸ’° ÐŸÐ¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ:
- CPU: Xm Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ
- Memory: XGi Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ

ðŸ“ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:
1. ...
2. ...
```

## ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸

| ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° | Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾ | ÐŸÑ€Ð¸ÐµÐ¼Ð»ÐµÐ¼Ð¾ | ÐŸÐ»Ð¾Ñ…Ð¾ |
|---------|--------|-----------|-------|
| CPU utilization | >70% | 40-70% | <40% |
| Memory utilization | >60% | 40-60% | <40% |
| Requests efficiency | >60% | 30-60% | <30% |

## ðŸ›¡ï¸ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

### Ð–ÑƒÑ€Ð½Ð°Ð» Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹: `docs/resource-changes.md`

**Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¶ÑƒÑ€Ð½Ð°Ð»Ð°:**
```markdown
# Resource Changes Log

## 2025-01-15: app-job-processing CPU ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ
- **Ð‘Ñ‹Ð»Ð¾:** 1500m â†’ **Ð¡Ñ‚Ð°Ð»Ð¾:** 500m
- **Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:** OOM Ñ‡ÐµÑ€ÐµÐ· 2 Ð´Ð½Ñ Ð¿Ñ€Ð¸ Ð¿Ð¸ÐºÐ¾Ð²Ð¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
- **ÐžÑ‚ÐºÐ°Ñ‚:** Ð²ÐµÑ€Ð½ÑƒÐ»Ð¸ 1500m
- **Ð’Ñ‹Ð²Ð¾Ð´:** ÐÐ• Ð¡ÐÐ˜Ð–ÐÐ¢Ð¬ Ð±ÐµÐ· Prometheus Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¿Ð¸ÐºÐ¾Ð²

## 2025-01-10: thumbor memory increase
- **Ð‘Ñ‹Ð»Ð¾:** 512Mi â†’ **Ð¡Ñ‚Ð°Ð»Ð¾:** 1Gi
- **ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** Ñ‡Ð°ÑÑ‚Ñ‹Ðµ OOM Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾
```

### ÐÐ• Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ:

| Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ | ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° |
|---------|---------|
| Workload Ð² Ð¶ÑƒÑ€Ð½Ð°Ð»Ðµ Ð¾Ñ‚ÐºÐ°Ñ‚Ð¾Ð² | Ð£Ð¶Ðµ Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ð»Ð¸, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ OOM |
| OOM Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 7 Ð´Ð½ÐµÐ¹ | ÐžÑ‡ÐµÐ²Ð¸Ð´Ð½Ñ‹Ð¹ Ñ€Ð¸ÑÐº |
| Production namespace | Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ ÑÐ²Ð½Ð¾Ð¹ Ð¿Ñ€Ð¾ÑÑŒÐ±Ñ‹ |
| Rails/Ruby apps (Ð½Ð¸Ð·ÐºÐ¸Ð¹ CPU) | I/O bound â€” ÑÑ‚Ð¾ ÐÐžÐ ÐœÐ |
| Job processing workloads | ÐŸÐ¸ÐºÐ¾Ð²Ñ‹Ðµ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½ÐµÐ¿Ñ€ÐµÐ´ÑÐºÐ°Ð·ÑƒÐµÐ¼Ñ‹ |
| ÐÐµÑ‚ Prometheus Ð´Ð°Ð½Ð½Ñ‹Ñ… | ÐÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ â€” Ð½ÐµÑ‚ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð² |

### Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð¾Ð¹

```
ðŸ“ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:

âœ… ÐœÐžÐ–ÐÐž ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—Ð˜Ð ÐžÐ’ÐÐ¢Ð¬:
1. dev/test-app: CPU 500m â†’ 100m (Prometheus max 7d: 45m)

âš ï¸ Ð—ÐÐ©Ð˜Ð©ÐÐÐÐ«Ð• (ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾):
- prod/api-server: Ð±Ñ‹Ð» OOM 3 Ð´Ð½Ñ Ð½Ð°Ð·Ð°Ð´
- prod/app-job-processing: Ð¾Ñ‚ÐºÐ°Ñ‚ Ð² docs/resource-changes.md
- stage/thumbor: burst workload

â“ ÐÐ£Ð–Ð•Ð ÐÐÐÐ›Ð˜Ð—:
- stage/new-service: efficiency 5%, Ð½Ð¾ Ð½ÐµÑ‚ Prometheus Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
```
