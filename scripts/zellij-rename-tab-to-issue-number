#!/usr/bin/env bash
#
# zellij-rename-tab-to-issue-number - Rename current zellij tab to issue number
#
# Usage: zellij-rename-tab-to-issue-number [issue-number]
#
# If issue number is not provided, tries to detect it from:
#   1. Current git branch name (e.g. feature/issue-123-description)
#   2. Current directory name (e.g. issue-123 or #123)
#   3. .issue-number file in current directory
#
# Does nothing if not inside a zellij session or issue number not found.

set -euo pipefail

# Exit early if not in zellij
if ! command -v zellij &> /dev/null || [[ -z "${ZELLIJ:-}" ]]; then
    exit 0
fi

detect_issue_number() {
    # 1. From git branch: feature/issue-123-description
    local branch
    branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")
    if [[ "$branch" =~ issue-([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
        return
    fi

    # 2. From current directory name: issue-123, #123, 123-description
    local dirname
    dirname=$(basename "$PWD")
    if [[ "$dirname" =~ issue-([0-9]+) ]] || [[ "$dirname" =~ ^#([0-9]+) ]] || [[ "$dirname" =~ ^([0-9]+)- ]]; then
        echo "${BASH_REMATCH[1]}"
        return
    fi

    # 3. From .issue-number file
    if [[ -f .issue-number ]]; then
        local content
        content=$(< .issue-number)
        if [[ "$content" =~ ([0-9]+) ]]; then
            echo "${BASH_REMATCH[1]}"
            return
        fi
    fi
}

if [[ $# -ge 1 ]]; then
    ISSUE_NUMBER="$1"
else
    ISSUE_NUMBER=$(detect_issue_number)
fi

if [[ -n "${ISSUE_NUMBER:-}" ]]; then
    script_dir="$(dirname "$(readlink -f "$0")")"
    "$script_dir/zellij-rename-tab" "${ZELLIJ_PANE_ID}" "#${ISSUE_NUMBER}"
fi
